<!DOCTYPE html>
<html lang="zh-cn">
 
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
        <title>板栗壳技术有限公司</title>
		<link rel="stylesheet" type="text/css" href="../../css/chat.css">
		<link rel="stylesheet" type="text/css" href="../../css/public.css">
		<script src="../../js/jquery1.10.2.min.js"></script>
		<script src="../../js/public.js"></script>
    </head>
    <body>
			<div class="app-top-2">
				<div class="app-top-3">
					<div class="app-top-5" onclick="app(1)">主页</div>
					<div class="app-top-5" onclick="app(2)">服务介绍</div>
					<div class="app-top-5" onclick="app(3)">项目案例</div>
					<div class="app-top-5" onclick="app(4)">关于我们</div>
					<div class="app-top-5" onclick="app(5)">帮助中心</div>
				</div>
				<div class="app-top-4">
					<div class="app-top-5" id="login" onclick="login()">登录</div>
					<div class="app-top-5" id="register" onclick="register()">注册</div>
				</div>
			</div>
			<div class="app-content">
				<div class="app-content-top">
					<div class="app-content-top-1">
						<img src="../../img/logo.png" />
						<div>
							<h1>在线列表</h1>
							<ul class="online_list" id="online_list"></ul>
							<h5>设置名字</h5>
							<div class="modify_name">
								<input type="text" class="modify_input" />
								<div>
									<button onclick="modify_name(1)">随机</button>
									<button onclick="modify_name(2)">确定</button>
								</div>
							</div>
						</div>
					</div>
					<div class="app-content-top-2">
						<div class="content-right">
							<div class="content-right-top">聊天页面<span></span></div>
						</div>
						<span class="title">板栗壳家庭群</span>
						<div class="content-left">
							<div class="chat_content" id="chat_content" >
							</div>
							<textarea  class="chat_textarea" id="chat_textarea"/></textarea>
							<input class="send_button" type="button" onclick="sub()" value="发送S" />
						</div>
					</div>
				</div>
				<div class="app-content-1">
					<div class="app-content-3" onclick="leavemsg()"><img class="icon-img" src="../../img/留言.png"> 留言</div>
					<div class="app-content-2" onclick="open_qq()">
						<a href="tencent://message/?uin=201747831&Site=Sambow&Menu=yes">
							<img class="icon-img" src="../../img/QQ.png">
						</a>
						联系
					</div>
					<div class="app-content-2" id="service"><img class="icon-img" src="../../img/二维码.png">客服</div>
					<div class="app-content-4" onclick="to_top()"><img class="icon-img" src="../../img/返回顶部.png">顶部</div>
				</div>
				<div class="WeChat" id="WeChat">
					<img src="../../img/kefu.png" class="WeChat_img" >
				</div>
			</div>
			<div class="footer">
				<div class="footer_parent">
					<div class="footer_1">
						<img src="../../img/kefu.png" class="WeChat_img" >
						<span>打开微信扫一扫</span>
					</div>
					<div class="footer_1">
						<div class="footer_1_1">
							<h5>团队信息</h5>
							<p onclick="app(4)">关于我们</p>
							<p onclick="app(3)">查看案例</p>
							<p onclick="app(2)">服务介绍</p>
						</div>
					</div>
					<div class="footer_1">
						<div class="footer_1_1">
							<h5>商务合作</h5>
							<p>开发合作</p>
							<p>广告合作</p>
							<p>其他</p>
						</div>
					</div>
					<div class="footer_1">
						<div class="footer_1_1">
							<h5 onclick="app(5)">帮助中心</h5>
							<p>忘记密码</p>
							<p onclick="register()">免费注册</p>
							<p onclick="leavemsg()">在线留言</p>
						</div>
					</div>
				</div>
				<div class="footer_parent_1">
					板栗壳技术有限公司 版权所有 粤ICP备17108118号
				</div>
				
			</div>
			

        <script>
			function randomWord(randomFlag, min, max){//随机数
						var str = "",
							range = min,
							arr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
							// 随机产生
							if(randomFlag){
								range = Math.round(Math.random() * (max-min)) + min;
							}
							for(var i=0; i<range; i++){
								pos = Math.round(Math.random() * (arr.length-1));
								str += arr[pos];
							}
							return str;
				}
	var tips=(data,classs)=>{
		var show_content= document.getElementById("chat_content")
		var div = document.createElement("div");
		
		var textnode=document.createTextNode(data);
		 div.appendChild(textnode)
		div.setAttribute("class", classs);
		show_content.appendChild(div);
		show_content.scrollTop = show_content.scrollHeight;//保持发送的内容在最底部显示
	}
	var chat_bubbles=(data,classs,classs1)=>{
		var show_content= document.getElementById("chat_content")
		var div = document.createElement("div");
		var img = document.createElement("img");
		img.setAttribute("src", "../../img/IE.png");
		img.setAttribute("class", classs1);
		div.appendChild(img);
		var textnode=document.createTextNode(data);
		 div.appendChild(textnode)
		div.setAttribute("class", classs);
		show_content.appendChild(div);
		show_content.scrollTop = show_content.scrollHeight;//保持发送的内容在最底部显示
	}
	var ws1 =()=>{
		let ws = new WebSocket("ws://localhost:3001");
		ws.onopen = function() {};
		return ws
	}
	var ws =ws1()
	window.onload=()=>{
		if($(".app-content")[0]){
			$(".app-content")[0].style.minHeight=window.innerHeight-80+"px"
		}
		if($(".chat_content")[0]){
			$(".app-content-top-1")[0].style.minHeight=window.innerHeight-330+"px"
		}
		if($(".chat_content")[0]){
			$(".chat_content")[0].style.minHeight=window.innerHeight-330+"px"
		}
		if($(".app-content-top-2")[0]){
			$(".app-content-top-2")[0].style.minHeight=window.innerHeight-80+"px"
		}
		$('#service').mouseover(function() {
			//console.log($('#WeChat')[0].style)
			$('#WeChat')[0].style.display = "block"
		}).mouseout(function() {
			$('#WeChat')[0].style.display = "none"
		})
		
		setTimeout(()=>{
			sub('hello')
		},2000)
		if(localStorage.getItem('random')){
			$(".modify_input")[0].value=localStorage.getItem('random')
		}
	};
	var sub=(data)=>{
		let times=new Date().getTime()//时间戳
		if(!localStorage.getItem('random')){
			random =randomWord(1,12,12);//随机一个id
			localStorage.setItem("random",random)
		}
		if(data==='hello'){
			ws.send(JSON.stringify({//发送消息
						join:localStorage.getItem('random') ? localStorage.getItem('random'):randomWord(1,12,12),
						times,times,
			}));
			
		}else if(data==='modify_name'){
			
		}else{
			var send_content=document.getElementById("chat_textarea").value;//需要发送的聊天内容
			document.getElementById("chat_textarea").value="";//清空已经发送的内容
			if(send_content==""){
				alert("请输入内容")
				return false
			}
			chat_bubbles(send_content,'chat_content_show_1','header_img2')
		}
	 	
				ws.send(JSON.stringify({//发送消息
									  message:send_content,
									  id:localStorage.getItem('random') ? localStorage.getItem('random'):randomWord(1,12,12),
									  times:times
				}));
				
				ws.onmessage = function(data) {//接收消息
				console.log(data)
					//let msg = "<div class='chat_content_show'>"+JSON.parse(data.data).message  +"</div>" 
					if(JSON.parse(data.data).num){
						$(".title")[0].innerHTML="板栗壳家庭群（"+JSON.parse(data.data).num+")";
						var html = ''
						JSON.parse(data.data).list.forEach(function each(data) {
							html =html+ "<li>"+data+"</li>"
						});
						$(".online_list")[0].innerHTML=html;
					/* 	 var show_content= document.getElementById("online_list")
						var li = document.createElement("li");
						var textnode=document.createTextNode(JSON.parse(data.data).list[0]);
						 li.appendChild(textnode)
						li.setAttribute("class", "chat_content_join");
						show_content.appendChild(li); */
						
					}else if(JSON.parse(data.data).message && JSON.parse(data.data).id===localStorage.getItem("random")){
						chat_bubbles(JSON.parse(data.data).message,'chat_content_show_1','header_img2')
					}else if(JSON.parse(data.data).message && JSON.parse(data.data).id!==localStorage.getItem("random")){
						chat_bubbles(JSON.parse(data.data).message,'chat_content_show','header_img1')
					}else if(JSON.parse(data.data).join){//新人加入
						tips(JSON.parse(data.data).join+'加入了群聊','chat_content_join')
					}else if(JSON.parse(data.data).close){
						tips(JSON.parse(data.data).close+'退出了群聊','chat_content_join')
					}else if(JSON.parse(data.data).modify_name){
						if(localStorage.getItem("random")==JSON.parse(data.data).modify_name 
						&& localStorage.getItem("times")==JSON.parse(data.data).times){
							tips('昵称已修改为：'+JSON.parse(data.data).modify_name ,'chat_content_join')
						}else{
							tips(JSON.parse(data.data).old_name+'昵称修改为：'+JSON.parse(data.data).modify_name,'chat_content_join')
						}
					}
				};
				ws.onclose = (params)=> {
					this.ws1()
				  console.log("client：关闭连接");
				  
				};

		
	}
	var modify_name=(data)=>{
		let times=new Date().getTime()//时间戳
		random =randomWord(1,12,12);//随机一个id
		if(data==1){
			$(".modify_input")[0].value=random
		}else if(data==2){
			var old_name=localStorage.getItem("random")
			localStorage.setItem("random",$(".modify_input")[0].value,"times",times)
			localStorage.setItem("times",times)
			ws.send(JSON.stringify({//发送消息
					modify_name:$(".modify_input")[0].value,
					times,times,
					old_name:old_name
			}));
		}
	}
        </script>
    </body>
</html>



